/**
 * ----------------------------------------------------------------------
 * aikotoba Backend - Complete v0.3.4
 * ----------------------------------------------------------------------
 * v0.3.4 å¤‰æ›´ç‚¹:
 * - æ­Œè©æ¤œç´¢ (searchLyricsLegacy) ã®çµæœã«å«ã¾ã‚Œã‚‹ display_text ã®å½¢å¼ã‚’å¤‰æ›´ã€‚
 * å¤‰æ›´å‰: æ­Œè© / æ›²å
 * å¤‰æ›´å¾Œ: æ­Œè©ï¼ˆæ›²åï¼‰
 * v0.3.3 å¤‰æ›´ç‚¹:
 * - æ­Œè©æ¤œç´¢ã«ãŠã„ã¦ã€é•·ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’çœç•¥ã™ã‚‹å‡¦ç†ã‚’å»ƒæ­¢ã€‚
 */


// ==========================================
// 1. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° (å¸ä»¤å¡”)
// ==========================================


function doGet(e) {
  const params = e.parameter || {};
  const mode = params.mode || 'lyrics';
  const query = params.q;


  let result;


  try {
    if (mode === 'title') {
      result = searchTitleData(query);
    } else if (mode === 'shiritori') {
      result = playShiritori(query);
    } else {
      result = searchLyricsLegacy(query);
    }
  } catch (error) {
    result = {
      status: 'error',
      message: error.toString()
    };
  }
 
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}


// ==========================================
// 2. ã—ã‚Šã¨ã‚Šãƒ­ã‚¸ãƒƒã‚¯
// ==========================================


function playShiritori(query) {
  if (!query) return { status: 'error', message: 'No query' };


  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('ã‚¿ã‚¤ãƒˆãƒ«');
  if (!sheet) return { status: 'error', message: 'Sheet "ã‚¿ã‚¤ãƒˆãƒ«" not found' };


   // ãƒ‡ãƒ¼ã‚¿å…¨å–å¾—
  const lastRow = sheet.getLastRow();
  const data = sheet.getRange(2, 1, lastRow - 1, 17).getValues();


   // 1. å…¥åŠ›ã•ã‚ŒãŸæ›²ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ & èª­ã¿ä»®åå–å¾—
  const qLower = query.toLowerCase();
  let currentSong = null;


  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const songName = String(row[9]);
    const songKana = String(row[16]);
   
     // å®Œå…¨ä¸€è‡´ã§æ¢ã™
    if (songName === query || songKana === query) {
      currentSong = {
        title: songName,
        kana: songKana,
        row: row
      };
      break;
    }
  }


   // æ›²ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
  if (!currentSong) {
    return {
      status: 'success',
      mode: 'shiritori',
      found: false,
      message: `ã€Œ${query}ã€ï¼ï¼Ÿæœªç™ºè¡¨æ›²ã‹ã‚‚...ğŸ¤”<br>æ­£å¼åç§°ã§æ•™ãˆã¦ã­ï¼`
    };
  }


   // 2. æœ€å¾Œã®æ–‡å­—ã‚’åˆ¤å®š
  let lastChar = getLastChar(currentSong.kana);
 
   // ã€Œã‚“ã€ã§çµ‚ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (lastChar === 'ã‚“') {
    return {
      status: 'success',
      mode: 'shiritori',
      found: true,
      game_over: true,
      current_song: currentSong,
      message: `ã‚ã‚ã£ï¼ã€Œ${currentSong.title}ã€ã¯ã€Œã‚“ã€ã§çµ‚ã‚ã‚‹ã‚ˆï¼<br>ä¿ºã®å‹ã¡ğŸ˜`
    };
  }


   // 3. æ¬¡ã®æ›²å€™è£œã‚’æ¢ã™
  let nextCandidates = [];
 
  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const targetKana = String(row[16]);
    const targetTitle = String(row[9]);


     // è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
    if (targetTitle === currentSong.title) continue;


     // ã‚«ãƒƒã‚³ã‚’å«ã‚€æ›²ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ï¼‰ã¯é™¤å¤–
    if (targetTitle.includes('(') || targetTitle.includes('ï¼ˆ')) continue;


     // æœ€åˆã®æ–‡å­—ãŒ lastChar ã¨ä¸€è‡´ã™ã‚‹ã‹
    if (targetKana.startsWith(lastChar)) {
      nextCandidates.push({
        title: targetTitle,
        kana: targetKana
      });
    }
  }


   // å€™è£œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æœ€å¤§5ä»¶è¿”ã™
  nextCandidates = shuffleArray(nextCandidates).slice(0, 5);


  return {
    status: 'success',
    mode: 'shiritori',
    found: true,
    game_over: false,
    current_song: currentSong,
    next_char: lastChar,
    candidates: nextCandidates,
    message: `ã€Œ${currentSong.title}ã€ã ã­ã€‚<br>æœ€å¾Œã¯ã€Œ${lastChar}ã€ã ã‹ã‚‰...<br>æ¬¡ã¯ã€Œ${lastChar}ã€ã‹ã‚‰å§‹ã¾ã‚‹æ›²ã ã‚ˆï¼`
  };
}


// ã—ã‚Šã¨ã‚Šç”¨ï¼šæœ€å¾Œã®æ–‡å­—ã‚’æŠ½å‡ºãƒ»æ­£è¦åŒ–
function getLastChar(kana) {
  if (!kana) return '';
  kana = kana.trim();
 
  let last = kana.slice(-1);
 
   // é•·éŸ³ã€Œãƒ¼ã€ã®å ´åˆã€ãã®å‰ã®æ–‡å­—ã‚’ä½¿ã†
  if (last === 'ãƒ¼' && kana.length > 1) {
    last = kana.slice(-2, -1);
  }
 
   // å°ã•ã„æ–‡å­—ã‚’å¤§ããã™ã‚‹
  const smallMap = { 'ã': 'ã‚', 'ãƒ': 'ã„', 'ã…': 'ã†', 'ã‡': 'ãˆ', 'ã‰': 'ãŠ', 'ã£': 'ã¤', 'ã‚ƒ': 'ã‚„', 'ã‚…': 'ã‚†', 'ã‚‡': 'ã‚ˆ', 'ã‚': 'ã‚' };
  if (smallMap[last]) {
    last = smallMap[last];
  }
 
  return last;
}


function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}




// ==========================================
// 3. æ¥½æ›²DB (ã‚¿ã‚¤ãƒˆãƒ«) æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================


function searchTitleData(query) {
  if (!query) return { status: 'error', message: 'No query' };


  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('ã‚¿ã‚¤ãƒˆãƒ«');
  if (!sheet) return { status: 'error', message: 'Sheet "ã‚¿ã‚¤ãƒˆãƒ«" not found' };


  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return { status: 'success', songs: [], albums: [], query: query };


  const data = sheet.getRange(2, 1, lastRow - 1, 17).getValues();
  const qLower = query.toLowerCase();
 
  let songMatches = [];
  let diskMatches = [];


  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const albTitle = String(row[2]);
    const sglTitle = String(row[6]);
    const songName = String(row[9]);
    const songKana = String(row[16]);


     // 1. æ›²åæ¤œç´¢
    if (songName.toLowerCase().includes(qLower) || songKana.includes(qLower)) {
      songMatches.push(formatSongData(row));


      if (sglTitle && sglTitle !== 'æœªåéŒ²') {
        diskMatches.push({ type: 'single', name: sglTitle, row: row });
      }
      if (albTitle && albTitle !== 'æœªåéŒ²') {
        diskMatches.push({ type: 'album', name: albTitle, row: row });
      }
    }
   
     // 2. ã‚¢ãƒ«ãƒãƒ /ã‚·ãƒ³ã‚°ãƒ«åæ¤œç´¢
    if (albTitle.toLowerCase().includes(qLower)) {
      diskMatches.push({ type: 'album', name: albTitle, row: row });
    } else if (sglTitle.toLowerCase().includes(qLower)) {
      diskMatches.push({ type: 'single', name: sglTitle, row: row });
    }
  }


  return {
    status: 'success',
    mode: 'title',
    query: query,
    songs: songMatches,
    albums: groupDisks(diskMatches, data)
  };
}


function formatSongData(row) {
  let releaseDateStr = (row[8] !== 'æœªåéŒ²' && row[8] !== '') ? row[8] : row[4];
  let age = calculateAikoAge(releaseDateStr);


  const sglInfo = (row[6] !== 'æœªåéŒ²' && row[6])
    ? `${formatDate(row[8])} ç™ºå£²ã® ${row[5]} æšç›®ã®ã‚·ãƒ³ã‚°ãƒ«ã€${row[6]}ã€ã® ${row[7]} æ›²ç›®ã«åéŒ²ã•ã‚Œã¦ã„ã‚‹ã‚ˆã€‚`
    : null;
   
  const albInfo = (row[2] !== 'æœªåéŒ²' && row[2])
    ? `${formatDate(row[4])} ç™ºå£²ã® ${row[1]} æšç›®ã®ã‚¢ãƒ«ãƒãƒ ã€${row[2]}ã€ã® ${row[3]} æ›²ç›®ã«åéŒ²ã•ã‚Œã¦ã„ã‚‹ã‚ˆã€‚`
    : null;


  const linkUrl = (row[14] && row[14] !== 'æœªåéŒ²') ? row[14] : row[15];


  return {
    title: row[9],
    reading: row[16],
    single_info: sglInfo,
    album_info: albInfo,
    arranger: row[10],
    duration: formatDuration(row[11]),
    bpm: row[12],
    age_at_release: age,
    link_url: linkUrl
  };
}


function groupDisks(matches, allData) {
  const uniqueDiskNames = [...new Set(matches.map(m => m.name))];
  let results = [];
 
  uniqueDiskNames.forEach(diskName => {
    const songsInDisk = allData.filter(row => String(row[2]) === diskName || String(row[6]) === diskName);
    if (songsInDisk.length === 0) return;


    const isAlbum = String(songsInDisk[0][2]) === diskName;
    const trackIdx = isAlbum ? 3 : 7;
    const dateIdx = isAlbum ? 4 : 8;


    songsInDisk.sort((a, b) => (Number(a[trackIdx]) || 99) - (Number(b[trackIdx]) || 99));


    results.push({
      disk_name: diskName,
      release_date: formatDate(songsInDisk[0][dateIdx]),
      songs: songsInDisk.map(row => ({ title: row[9], order: row[trackIdx] }))
    });
  });
  return results;
}


// ==========================================
// 3. æ­Œè©æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ (v0.3.4 æ”¹ä¿®)
// ==========================================


function searchLyricsLegacy(query) {
  if (!query) return { status: 'error', message: 'No query' };


  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName('æ­Œè©');
  if (!sheet) sheet = ss.getSheetByName('ã‚·ãƒ¼ãƒˆ1');
  if (!sheet) return { status: 'error', message: 'Lyrics Sheet not found' };


  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return { status: 'success', results: [], query: query, random_message: "" };


  const data = sheet.getRange(2, 1, lastRow - 1, 5).getValues();
  const results = [];
  const qLower = query.toLowerCase();


  for (let i = 0; i < data.length; i++) {
    const row = data[i];
   
     // æ­Œè©ã‚«ãƒ©ãƒ ã¨æ¨æ¸¬ã•ã‚Œã‚‹éƒ¨åˆ†(index 1ä»¥é™)ã ã‘ã‚’çµåˆã—ã¦æ¤œç´¢å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œã‚‹
    let searchTarget = "";
    for (let j = 1; j < row.length; j++) {
      searchTarget += String(row[j]) + " ";
    }
   
     // æ­Œè©éƒ¨åˆ†ã«ãƒ’ãƒƒãƒˆã—ãŸå ´åˆã®ã¿çµæœã«è¿½åŠ 
    if (searchTarget.toLowerCase().includes(qLower)) {
      const title = row[0];
      let lyrics = "";
     
      // ä¸€ç•ªé•·ã„æ–‡å­—åˆ—ãŒå…¥ã£ã¦ã„ã‚‹ã‚»ãƒ«ã‚’ã€Œæ­Œè©ã€ã¨ã—ã¦æ¡ç”¨
      for (let j = 1; j < row.length; j++) {
        if (String(row[j]).length > String(lyrics).length) {
          lyrics = String(row[j]);
        }
      }


      const snippet = lyrics; // å…¨æ–‡è¡¨ç¤º


      // â˜…ä¿®æ­£: ã‚³ãƒ”ãƒ¼ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚’ã€Œæ­Œè©ï¼ˆæ›²åï¼‰ã€ã«å¤‰æ›´
      results.push({
        title: title,
        phrase: snippet,
        display_text: `${snippet}ï¼ˆ${title}ï¼‰`
      });
    }
  }


  let randomMsg = "";
  if (data.length > 0) {
    const randomRow = data[Math.floor(Math.random() * data.length)];
    const rawLyrics = randomRow[1];
    if (rawLyrics) {
      randomMsg = String(rawLyrics).replace(/\r?\n/g, ' ');
    }
  }


  return {
    status: 'success',
    mode: 'lyrics',
    results: results,
    query: query,
    random_message: randomMsg
  };
}


// ==========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ==========================================


function formatDuration(val) {
  if (!val) return 'ä¸æ˜';
  if (val instanceof Date) {
    return Utilities.formatDate(val, 'JST', 'm:ss');
  }
  return String(val);
}


function calculateAikoAge(dateStr) {
  if (!dateStr || dateStr === 'æœªåéŒ²') return null;
  const birthDate = new Date(1975, 10, 22);
  const targetDate = new Date(dateStr);
  if (isNaN(targetDate.getTime())) return null;
  let age = targetDate.getFullYear() - birthDate.getFullYear();
  const m = targetDate.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && targetDate.getDate() < birthDate.getDate())) age--;
  return age;
}


function formatDate(val) {
  if (!val || val === 'æœªåéŒ²') return 'ä¸æ˜';
  if (val instanceof Date) {
    return Utilities.formatDate(val, 'JST', 'yyyy/MM/dd');
  }
  return String(val).substring(0, 10);
}



