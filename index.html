<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- 
      viewportè¨­å®š: ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆç„¡åŠ¹åŒ–
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aikotoba - aikoæ­Œè©ï¼†æ¥½æ›²DB</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; transition: background-color 0.3s ease; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .send-btn-active:active { transform: scale(0.9); }

        /* iPhone Safe Areaå¯¾ç­– */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç‚¹æ»…ï¼‰ */
        .pulse-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®èª¿æ•´ã‚¯ãƒ©ã‚¹ */
        .message-row { scroll-margin-top: 6rem; }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .highlight-text {
            color: #ea580c; /* orange-600 */
            font-weight: bold;
            background-color: #fff7ed; /* orange-50 */
            padding: 0 2px;
            border-radius: 2px;
        }

        /* å¹ãå‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .bubble { position: relative; border-radius: 1.2rem; }
        .bubble-right::before {
            content: ""; position: absolute; top: 10px; right: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 0 6px 10px;
            border-color: transparent transparent transparent var(--bubble-color, #f97316);
        }
        .bubble-left::before {
            content: ""; position: absolute; top: 10px; left: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 10px 6px 0;
            border-color: transparent #ffffff transparent transparent;
        }

        /* ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-active {
            border-bottom-width: 2px;
            font-weight: bold;
        }
        
        /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¤‰æ•° (JSã§åˆ¶å¾¡) */
        :root {
            --theme-color-primary: #f97316; /* Orange-500 */
            --theme-color-bg: #fff7ed;      /* Orange-50 */
            --bubble-color: #f97316;
        }
        
        /* ãƒ†ãƒ¼ãƒåˆ¥ä¸Šæ›¸ãã‚¯ãƒ©ã‚¹ */
        .theme-lyrics .text-theme { color: #f97316; }
        .theme-lyrics .bg-theme { background-color: #f97316; }
        .theme-lyrics .bg-theme-soft { background-color: #fff7ed; }
        .theme-lyrics .border-theme { border-color: #ffedd5; }

        .theme-title .text-theme { color: #0ea5e9; } /* Sky-500 */
        .theme-title .bg-theme { background-color: #0ea5e9; }
        .theme-title .bg-theme-soft { background-color: #f0f9ff; } /* Sky-50 */
        .theme-title .border-theme { border-color: #e0f2fe; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
    </style>
</head>
<body id="app-body" class="bg-orange-50 text-gray-800 h-screen flex flex-col theme-lyrics transition-colors duration-300">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/95 backdrop-blur-sm shadow-sm flex flex-col items-center justify-center sticky top-0 z-20 border-b border-theme relative transition-colors duration-300">
        <!-- ä¸Šéƒ¨ï¼šã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ˜ãƒ«ãƒ— -->
        <div class="w-full flex items-center justify-center p-2 relative">
            <h1 class="text-lg font-bold text-theme tracking-wider flex items-baseline transition-colors duration-300">
                aikotoba
                <span id="version-display" class="ml-2 text-[10px] text-gray-400 font-normal opacity-50"></span>
            </h1>
            <button onclick="toggleModal(true)" class="absolute right-4 text-gray-400 hover:text-theme transition p-1 rounded-full hover:bg-gray-50">
                <i data-lucide="help-circle" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="flex w-full px-4 gap-4 text-sm justify-center">
            <button id="tab-lyrics" onclick="switchTab('lyrics')" class="flex-1 pb-2 text-center text-orange-500 border-orange-500 tab-active transition-all">
                æ­Œè©æ¤œç´¢
            </button>
            <button id="tab-title" onclick="switchTab('title')" class="flex-1 pb-2 text-center text-gray-400 border-transparent hover:text-sky-400 transition-all">
                æ¥½æ›²DB
            </button>
        </div>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-40"> 
        
        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (Bot) -->
        <div class="flex items-start space-x-2">
            <img id="bot-icon-initial" src="" alt="hoki" class="w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p id="initial-message" class="text-sm leading-relaxed">
                    å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼
                </p>
            </div>
        </div>

    </main>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <footer class="bg-white px-3 py-2 border-t border-gray-100 fixed bottom-0 w-full safe-pb z-30" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
        <!-- ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©ã‚¨ãƒªã‚¢ -->
        <div id="random-lyric-area" class="text-[10px] text-gray-400 text-center mb-1 h-4 truncate transition-opacity"></div>

        <form id="search-form" class="flex items-center gap-2">
            <div class="flex-1 bg-gray-100 rounded-full flex items-center px-4 py-2 transition-colors focus-within:bg-white focus-within:ring-1 focus-within:ring-gray-200">
                <input type="text" id="search-input" 
                    class="flex-1 bg-transparent border-none focus:outline-none text-sm placeholder-gray-400"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off">
            </div>
            
            <button type="submit" 
                class="send-btn-active text-theme p-2 rounded-full hover:bg-theme-soft transition flex-shrink-0">
                <i data-lucide="send" class="w-6 h-6 fill-current transition-colors duration-300"></i>
            </button>
        </form>
    </footer>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <!-- Readme ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all scale-100">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-theme flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5"></i> ä½¿ã„æ–¹
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-sm text-gray-700 leading-relaxed overflow-y-auto max-h-[60vh]">
                <section>
                    <h3 class="font-bold text-gray-800 mb-1">ğŸŸ§ æ­Œè©æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰</h3>
                    <p class="text-xs">
                        ã€Œç”˜ã„åŒ‚ã„ã«ã€ãªã©ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®æ­Œè©ãŒå«ã¾ã‚Œã‚‹æ›²ã‚’æ¢ã—ã¾ã™ã€‚
                        ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠå¤‰æ›ã‚‚è‡ªå‹•ã§è¡Œã„ã¾ã™ã€‚
                    </p>
                </section>

                <section>
                    <h3 class="font-bold text-sky-600 mb-1">ğŸŸ¦ æ¥½æ›²DBãƒ¢ãƒ¼ãƒ‰</h3>
                    <p class="text-xs">
                        æ›²åï¼ˆä¾‹ï¼šã€Œæœã¦ã—ãªã„äºŒäººã€ï¼‰ã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã™ã‚‹ã¨ã€
                        ç™ºå£²æ—¥ã€åéŒ²é †ã€å½“æ™‚ã®aikoã®å¹´é½¢ãªã©ã‚’è©³ã—ãè¡¨ç¤ºã—ã¾ã™ã€‚
                    </p>
                </section>
                
                <section class="text-center pt-2">
                    <p class="text-xs text-gray-400">aikotoba v0.2.0</p>
                </section>
            </div>
            
            <button onclick="toggleModal(false)" class="mt-6 w-full bg-gray-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-gray-600 transition active:scale-95">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // ã‚¢ãƒ—ãƒªè¨­å®š
        // ==========================================
        const APP_VERSION = 'v0.2.0';
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby49eACsPr_lGblpklhK13gt4TroRwNyKwnQcKQ3GPhACQ8zV96YZ9_CDXfFn5wOj85/exec"; 
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}?v=${APP_VERSION}`;

        // çŠ¶æ…‹ç®¡ç†
        let currentMode = 'lyrics'; // 'lyrics' or 'title'

        // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const LOADING_MESSAGES = {
            lyrics: [
                "aikoã®ãƒã‚±ãƒƒãƒˆã®ä¸­ã‚’æ¢ã—ã¦ã„ã¾ã™...",
                "æ­Œè©ã®æ˜Ÿå±‘ã‚’é›†ã‚ã¦ã„ã¾ã™...",
                "ãƒ†ãƒˆãƒ©ãƒãƒƒãƒˆã®è£å´ã‚’ç¢ºèªä¸­..."
            ],
            title: [
                "CDãƒ©ãƒƒã‚¯ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...",
                "ãƒ–ãƒƒã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚ãã£ã¦ã„ã¾ã™...",
                "ãƒªãƒªãƒ¼ã‚¹æ—¥ã‚’æ€ã„å‡ºã—ã¦ã„ã¾ã™..."
            ]
        };

        const dom = {
            body: document.getElementById('app-body'),
            chatContainer: document.getElementById('chat-container'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            randomArea: document.getElementById('random-lyric-area'),
            toast: document.getElementById('toast'),
            version: document.getElementById('version-display'),
            modal: document.getElementById('readme-modal'),
            initialMsg: document.getElementById('initial-message'),
            initialIcon: document.getElementById('bot-icon-initial'),
            tabLyrics: document.getElementById('tab-lyrics'),
            tabTitle: document.getElementById('tab-title')
        };

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (dom.version) dom.version.textContent = APP_VERSION;
            if (dom.initialIcon) dom.initialIcon.src = ICON_URL;
            new Image().src = ICON_URL; // Preload
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        window.switchTab = function(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            
            // ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            if (mode === 'lyrics') {
                dom.body.classList.replace('theme-title', 'theme-lyrics');
                dom.body.classList.replace('bg-sky-50', 'bg-orange-50');
                
                // ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
                dom.tabLyrics.className = "flex-1 pb-2 text-center text-orange-500 border-orange-500 tab-active transition-all";
                dom.tabTitle.className = "flex-1 pb-2 text-center text-gray-400 border-transparent hover:text-sky-400 transition-all";
                
                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                dom.searchInput.placeholder = "ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«";
                dom.randomArea.style.opacity = '1';
                
                // CSSå¤‰æ•°æ›´æ–° (å¹ãå‡ºã—è‰²ãªã©)
                document.documentElement.style.setProperty('--bubble-color', '#f97316'); // orange-500

            } else {
                dom.body.classList.replace('theme-lyrics', 'theme-title');
                dom.body.classList.replace('bg-orange-50', 'bg-sky-50');

                // ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
                dom.tabTitle.className = "flex-1 pb-2 text-center text-sky-600 border-sky-500 tab-active transition-all";
                dom.tabLyrics.className = "flex-1 pb-2 text-center text-gray-400 border-transparent hover:text-orange-400 transition-all";

                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                dom.searchInput.placeholder = "ä¾‹ï¼šæœã¦ã—ãªã„äºŒäººã€æ¹¿ã£ãŸå¤ã®å§‹ã¾ã‚Š";
                dom.randomArea.style.opacity = '0'; // DBãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©éè¡¨ç¤º

                // CSSå¤‰æ•°æ›´æ–°
                document.documentElement.style.setProperty('--bubble-color', '#0ea5e9'); // sky-500
            }

            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´ï¼ˆå±¥æ­´ãŒãªã„å ´åˆã®ã¿å¤‰ãˆã‚‹ã®ã‚‚ã‚ã‚Šã ãŒã€ä»Šå›ã¯é›°å›²æ°—ä½œã‚Šã®ãŸã‚ãƒªã‚»ãƒƒãƒˆã¯ã—ãªã„ï¼‰
        };

        // é€ä¿¡å‡¦ç†
        dom.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = dom.searchInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            dom.searchInput.value = '';

            const loadingId = addLoading();

            try {
                // modeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await response.json();

                removeLoading(loadingId);

                if (data.status === 'success') {
                    if (currentMode === 'lyrics') {
                        handleLyricsResults(data);
                    } else {
                        handleTitleResults(data);
                    }
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }

            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        // ---------------------------------------------------------
        // æ­Œè©æ¤œç´¢ çµæœè¡¨ç¤º (v0.1æº–æ‹ )
        // ---------------------------------------------------------
        function handleLyricsResults(data) {
            if (data.random_message) {
                dom.randomArea.textContent = 'ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼š' + data.random_message;
            }

            if (!data.results || data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ...ğŸ’¦`, 'bot');
                return;
            }

            if (data.is_fuzzy) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©...<br>ã‚‚ã—ã‹ã—ã¦ã€ã“ã‚Œã‹ãªï¼Ÿ`, 'bot');
            }

            let contentHtml = '<div class="flex flex-col animate-fade-in">';
            
            data.results.forEach((item, index) => {
                const borderClass = index < data.results.length - 1 ? 'border-b border-dashed border-theme' : '';
                const highlightedPhrase = item.phrase.replace(
                    new RegExp(`(${data.query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), 
                    '<span class="highlight-text">$1</span>'
                );
                const displayTextHtml = `${highlightedPhrase} <span class="text-xs text-gray-400 ml-1">ï¼ˆ${item.title}ï¼‰</span>`;

                contentHtml += `
                    <div onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" 
                         class="${borderClass} py-3 cursor-pointer hover:bg-theme-soft transition relative group select-none">
                        <p class="text-sm font-medium text-gray-700 leading-relaxed pl-1">
                            ${displayTextHtml}
                        </p>
                    </div>
                `;
            });
            contentHtml += '</div>';

            // ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼
            const allText = data.results.map(item => item.display_text).join('\\n').replace(/'/g, "\\'");
            
            contentHtml += `
                <div class="animate-fade-in mt-3 pt-2 border-t border-dashed border-theme">
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <p class="text-[10px] text-gray-400">è¨ˆ${data.results.length}ç®‡æ‰€ã§è¦‹ã¤ã‹ã£ãŸã‚ˆâ™ª</p>
                        <button onclick="copyToClipboard('${allText}')" 
                                class="text-[10px] text-theme hover:text-opacity-80 flex items-center gap-1 bg-theme-soft px-3 py-1.5 rounded-full transition shadow-sm border border-theme">
                            <i data-lucide="copy" class="w-3 h-3"></i> ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
            `;

            addMessage(contentHtml, 'bot', true);
            lucide.createIcons();
        }

        // ---------------------------------------------------------
        // æ¥½æ›²DB çµæœè¡¨ç¤º (v0.2æ–°è¦)
        // ---------------------------------------------------------
        function handleTitleResults(data) {
            if (!data.results || data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ...ğŸ“š`, 'bot');
                return;
            }

            // çµæœã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤ºã‚’å¤‰ãˆã‚‹
            // data.type: 'song' (æ›²æ¤œç´¢) or 'album' (ã‚¢ãƒ«ãƒãƒ /ã‚·ãƒ³ã‚°ãƒ«æ¤œç´¢)
            
            let contentHtml = '<div class="flex flex-col gap-4 animate-fade-in">';

            if (data.type === 'song') {
                // --- æ›²è©³ç´°è¡¨ç¤º ---
                data.results.forEach((song, idx) => {
                    const hasDivider = idx > 0 ? 'border-t border-sky-100 pt-4' : '';
                    
                    // aikoå¹´é½¢ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
                    const ageText = song.age_at_release ? `ãƒªãƒªãƒ¼ã‚¹æ™‚ã®aikoã¯<span class="font-bold text-sky-600">${song.age_at_release}æ­³</span>ã ã‚ˆã€‚` : '';

                    // ãƒªãƒ³ã‚¯ç”Ÿæˆ
                    const songLink = song.link_url ? 
                        `<a href="${song.link_url}" target="_blank" class="text-sky-600 underline font-bold hover:text-sky-400">${song.title}</a>` :
                        `<span class="font-bold text-gray-800">${song.title}</span>`;

                    contentHtml += `
                        <div class="${hasDivider}">
                            <div class="mb-2 text-base">
                                ${songLink} <span class="text-xs text-gray-400">(${song.reading || ''})</span>
                            </div>
                            
                            <div class="text-sm text-gray-700 space-y-2 leading-relaxed bg-sky-50/50 p-3 rounded-lg border border-sky-100">
                                ${song.single_info ? `<p>ğŸ’¿ ${song.single_info}</p>` : ''}
                                ${song.album_info ? `<p>ğŸ’¿ ${song.album_info}</p>` : '<p class="text-gray-400">ğŸ’¿ ã‚¢ãƒ«ãƒãƒ ã«ã¯æœªåéŒ²ã ã‚ˆã€‚</p>'}
                                
                                <div class="pt-2 border-t border-sky-100 text-xs text-gray-600">
                                    <p>ğŸ¼ ç·¨æ›²ï¼š${song.arranger || 'ä¸æ˜'}</p>
                                    <p>â± å†ç”Ÿæ™‚é–“ï¼š${song.duration || 'ä¸æ˜'}</p>
                                    <p>ğŸ¥ BPMï¼š${song.bpm || 'ç¢ºèªä¸­'}</p>
                                </div>
                                
                                <p class="pt-1 text-xs text-sky-700 font-medium">${ageText}</p>
                            </div>
                        </div>
                    `;
                });

            } else {
                // --- ã‚¢ãƒ«ãƒãƒ /ã‚·ãƒ³ã‚°ãƒ«åéŒ²æ›²è¡¨ç¤º ---
                data.results.forEach((disk) => {
                    const songList = disk.songs.map((s, i) => 
                        `<li class="py-1 border-b border-sky-50 last:border-0 flex gap-2">
                            <span class="text-sky-400 w-4 text-right">${s.order}.</span>
                            <span>${s.title}</span>
                        </li>`
                    ).join('');

                    contentHtml += `
                        <div class="bg-sky-50/50 rounded-xl p-4 border border-sky-100">
                            <h3 class="font-bold text-sky-700 mb-1">ğŸ’¿ ${disk.disk_name}</h3>
                            <p class="text-xs text-gray-500 mb-3">${disk.release_date} ç™ºå£²</p>
                            <ul class="text-sm text-gray-700 list-none">
                                ${songList}
                            </ul>
                        </div>
                    `;
                });
            }

            contentHtml += '</div>';
            
            // ãƒ•ãƒƒã‚¿ãƒ¼ (ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ã®ã¿)
            contentHtml += `
                <div class="flex justify-center mt-3 pt-2">
                    <button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" 
                            class="text-[10px] text-sky-300 hover:text-sky-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white">
                        <i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•
                    </button>
                </div>
            `;

            addMessage(contentHtml, 'bot', true);
            lucide.createIcons();
        }

        // ==========================================
        // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ==========================================
        function addMessage(htmlOrText, type, shouldScroll = true) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;

            const iconHtml = type === 'bot' 
                ? `<img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10">` 
                : '';
            
            // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦Botã®å¹ãå‡ºã—è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆJSå¤‰æ•°ã§ã‚¯ãƒ©ã‚¹åˆ¶å¾¡ã‚‚å¯èƒ½ã ãŒCSSå¤‰æ•°ã§å¯¾å¿œï¼‰
            const bubbleClass = type === 'user' 
                ? 'bubble bubble-right text-white' 
                : 'bubble bubble-left bg-white text-gray-800';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹ãå‡ºã—ã®èƒŒæ™¯è‰²ã‚’ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦å¤‰æ›´
            const userBgClass = currentMode === 'lyrics' ? 'bg-orange-500' : 'bg-sky-500';
            const finalBubbleClass = type === 'user' ? `${bubbleClass} ${userBgClass}` : bubbleClass;

            const contentHtml = `
                <div class="${finalBubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm break-words leading-relaxed">
                    ${htmlOrText}
                </div>
            `;

            div.innerHTML = type === 'bot' ? iconHtml + contentHtml : contentHtml;
            dom.chatContainer.appendChild(div);
            
            if (shouldScroll) scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            
            const msgs = LOADING_MESSAGES[currentMode];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];

            div.innerHTML = `
                <img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10">
                <div class="bubble bubble-left bg-white px-4 py-3 shadow-sm">
                    <p class="text-sm text-gray-500 pulse-text">
                        ${randomMsg}
                    </p>
                </div>
            `;
            dom.chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
        }

        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cleanText).then(showToast);
            } else {
                const ta = document.createElement('textarea');
                ta.value = cleanText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast();
            }
        }

        function showToast() {
            dom.toast.classList.remove('opacity-0');
            setTimeout(() => dom.toast.classList.add('opacity-0'), 2000);
        }

        function toggleModal(show) {
            if (show) {
                dom.modal.classList.remove('hidden');
                setTimeout(() => {
                    dom.modal.querySelector('div:last-child').classList.remove('modal-enter');
                    dom.modal.querySelector('div:last-child').classList.add('modal-enter-active');
                }, 10);
            } else {
                dom.modal.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
